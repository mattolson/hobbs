# Hobbs - Personal AI Agent
#
# Quick start:
#   mkdir -p ~/.local/share/hobbs ~/hobbs/workspace
#   cd ~/hobbs
#   curl -O <release-url>/docker-compose.yml
#   curl -O <release-url>/policy.yaml
#   docker compose up -d
#   docker compose exec hobbs zsh
#   claude
#   docker compose down
#
# Directory layout (host):
#   ~/hobbs/
#     docker-compose.yml       # This file
#     policy.yaml              # Network allowlist
#     workspace/               # Shared working directory (bind-mounted)
#   ~/.local/share/hobbs/      # Instance data (bind-mounted)
#
# Configuration (environment variables):
#   WORKSPACE     - Host directory for shared working files (default: ~/hobbs/workspace)
#   HOBBS_DATA    - Host directory for instance data (default: ~/.local/share/hobbs)
#   TZ            - Timezone (default: America/Los_Angeles)

services:
  proxy:
    image: ghcr.io/mattolson/agent-sandbox-proxy:latest
    environment:
      - PROXY_MODE=enforce
    volumes:
      - proxy-state:/home/mitmproxy/.mitmproxy
      - proxy-ca:/ca-export
      - ./policy.yaml:/etc/mitmproxy/policy.yaml:ro
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 3s
      retries: 3

  hobbs:
    image: ghcr.io/mattolson/hobbs:latest
    depends_on:
      proxy:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      # Shared working directory
      - ${WORKSPACE:-${HOME}/hobbs/workspace}:/home/dev/hobbs/workspace
      # Hobbs instance data (memories, foundation, playbooks, vault)
      - ${HOBBS_DATA:-${HOME}/.local/share/hobbs}:/home/dev/.hobbs
      # Persist Claude credentials and state
      - claude-state:/home/dev/.claude
      # Persist shell history
      - claude-history:/commandhistory
      # Proxy CA certificate (public cert only, no private key)
      - proxy-ca:/etc/mitmproxy:ro
      # User dotfiles (optional - auto-linked into $HOME at startup)
      # - ${HOME}/.config/agent-sandbox/dotfiles:/home/dev/.dotfiles:ro
      # Shell customizations (optional - scripts sourced at shell startup)
      # - ${HOME}/.config/agent-sandbox/shell.d:/home/dev/.config/agent-sandbox/shell.d:ro
    working_dir: /home/dev/hobbs/workspace
    stdin_open: true
    tty: true
    environment:
      - TZ=${TZ:-America/Los_Angeles}
      - CLAUDE_CONFIG_DIR=/home/dev/.claude
      - HTTP_PROXY=http://proxy:8080
      - HTTPS_PROXY=http://proxy:8080
      - NO_PROXY=localhost,127.0.0.1,proxy
      - GODEBUG=http2client=0

volumes:
  claude-state:
  claude-history:
  proxy-state:
  proxy-ca:
